# 分群分析group_by()

<div class="alert white">
cheatsheet截圖對照<a data-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false" aria-controls="collapseExample"><i class="fa fa-image"></i></a>
</div>

```{r, eval=TRUE, echo=FALSE}
library(htmltools)
HTML('
<div class="collapse" id="collapseExample">
<h3>第一部分</h3>
<img src="./graph/group_by.png" style="width:50%">
</div>
     ')
```


#### 分群分析與群內排序{-}

> `group_by()`函數會由原本資料集產生一個新的分群過的資料集，通常會與`summarise`函數一起運用。可以直接理解為group by certain variable。

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE)
```

```{r, echo=FALSE, include=TRUE}
klippy::klippy()
```

```{r, include=FALSE}
library(dplyr)
library(nycflights13)
library(SportsAnalytics)
library(tibble)
fetch_NBAPlayerStatistics("17-18") -> NBA1718
```

1. 用group_by函數看看「哪一家航空公司(carrier)」的「平均起飛延遲」最嚴重？
```{r, warning=FALSE}
flights %>% group_by(carrier) %>% 
            summarise_at(vars(dep_delay), funs(mean), na.rm = T) %>% 
            arrange(desc(dep_delay)) %>% rename(dep_delay_mean = dep_delay)
```
  
2. 可以設定多個分組依據
```{r}
# 我想要知道個別`航空公司(carrier) `，哪些`航班路線(Flight number)`起飛通常比較容易遇到延遲？
flights %>% group_by(carrier, flight) %>% 
            summarise_at(vars(dep_delay), funs(mean), na.rm = T) %>% 
            arrange(desc(dep_delay)) %>% rename(dep_delay_mean = dep_delay)
```

3. 我想要知道1~12月份，「各月份」的「每一天」，航班「平均起飛延遲」嚴重程度？（group_by + arrange組合技）
```{r}
#意思就是，群內（或者說組內）排序怎麼做？
#請查詢 Help，重點是arrange函數裡面的 .by_group 參數
flights %>% group_by(month, day) %>% 
            summarise_at(vars(dep_delay), funs(mean), na.rm = T) %>% 
            arrange(desc(dep_delay), .by_group = T)
```

### 範例{-}

> 若完成，請直接貼到open chat

1. 若有一位買家對於這32台車子很有興趣，特別是在省油表現（Miles/(US) gallon, mpg)，以及馬力表現(hp, Gross horsepower)有很大的興趣，你要整理哪些資料？

2. 後來他希望能夠買到馬力性能比較強的車，他要求你將馬力表現高於平均的車款額外整理給他，應該怎麼做呢？

3. 假設這位買家最近試駕了很多台車款，閒聊時候偶然跟你分享他獨家的選車know-how，標準是省油表現（Miles/(US) gallon,mpg)數字的十倍，再加上馬力表現的總和，越高越好，請問哪一台車應該是他的心頭好？

4. 要成交前，該位買家因為莫名原因心情好，決定要買他挑選標準該數據的前三名，請問你應該給他哪三台車的最終報價？

5. 服務完這位客戶後，發現自己累積了不少經驗，也留意到汽缸數多寡與馬力有一定關聯性，閒來之餘想要整理一下相同汽缸數下，不同車款的馬力比較表作為往後參考，請問該怎麼做？

```{r, eval=FALSE}
mtcars
```

```{r, eval=FALSE,include=FALSE}
mtcars %>% group_by(cyl) %>% arrange(desc(hp), .by_group = T)
```

### 自主練習{-}

1. (延續上一題）休士頓火箭隊，各個守備位置各有多少人？

> 1. 隊(Team)、守備位置(Position)是兩個分組條件<br>
  2. 計算row（或者說樣本個數），可以用n(), number of values/rows，可參考dplyr cheatsheet

```{r, eval=FALSE,include=FALSE}
NBA1718 %>% group_by(Team, Position) %>% summarise(nPlayer = n()) %>% filter(Team == "HOU")
```




